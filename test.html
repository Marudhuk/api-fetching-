<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./testStyle.css">
</head>

<body>
    <div class="whole">
        <div class="left">
            <h3>CRUD</h3>
            <form id="myForm">
                <label for="title">Name</label>
                <input type="text" name="name" id="name"  required><br>
                <label for="body">Email</label>
                <input type="text" name="email" id="email"  required><br>
                <label for="user">Message</label>
                <input type="text" name="message" id="message"  required><br>
                <input type="button" value="Create User" disabled="true" onclick="createUser()" id="btn">
                <input type="hidden" name="id" id="forId">
                <button type="button" disabled="true" onclick="resetForm()" id="resetBtn">Reset</button>
            </form>
        </div>
        <div class="right">
            <h3>Details</h3>
            <table id="myMoviesTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Message</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="userTable">

                </tbody>
            </table>
        </div>
    </div>

    <script>
        getData();
        let userId;
        let btn = false;
        let name = document.getElementById("name");
        let email = document.getElementById("email");
        let messages = document.getElementById("message");
        let arr = []
        arr.push(name, email, messages);
        arr.forEach(e => {
            e.addEventListener("input", () => {
                if (name.value.length || email.value.length || messages.value.length) {
                    document.getElementById("resetBtn").disabled = false;
                    document.getElementById("btn").disabled = false;
                    document.getElementById("resetBtn").style.cursor = "pointer";
                }
                else {
                    document.getElementById("resetBtn").disabled = true;
                    document.getElementById("btn").disabled = true;

                }
            })
        })

        function createUser() {
            console.log("Create user")
            fetch('http://localhost:4000/postdata', {
                method: 'POST',
                body: JSON.stringify({
                    name: document.getElementById("name").value,
                    email: document.getElementById("email").value,
                    messages: document.getElementById("message").value,
                }),
                headers: {
                    'Content-type': 'application/json; charset=UTF-8',
                },
            })
                .then((response) => response.json())
                .then((json) => {
                    console.log(json)
                    getData();
                    resetForm();
                });
        }

        function getData() {
            fetch('http://localhost:4000/getAllUsers')
                .then(res => res.json())
                .then(users => {
                    console.log(users, 'dfghjkl');
                    html = ''
                    users.forEach(a => {
                        html += `<tr><td>${a.username}</td><td>${a.email}</td><td>${a.messages}</td>
                        <td><button class="edit-btn" onclick="editData(${a.id})">Edit</button>
                        <button class="delete-btn" onclick="deleteData(${a.id})">Delete</button></td></tr>`
                    })
                    console.log(html, "HTML")
                    document.getElementById("userTable").innerHTML = html;
                })
        }

        function editData(id) {
            btn = true;
            console.log('edittt');
            fetch('http://localhost:4000/getById/' + id)
                .then(res => res.json())
                .then(users => {
                    console.log(users)
                    let { id, username, email, messages } = users[0]
                    document.getElementById('forId').value = id;
                    document.getElementById("name").value = username;
                    document.getElementById("email").value = email;
                    document.getElementById("message").value = messages;
                    document.getElementById("resetBtn").disabled = false;
                })
            if (btn) {
                document.getElementById("btn").value = "Update Data";
                document.getElementById("btn").onclick = updateData;
            }
            else {
                document.getElementById("btn").value = "Create user";
                document.getElementById("btn").onclick = createUser;
            }
        }

        function updateData() {
            btn = false;
            console.log('update..')
            userId = document.getElementById("forId").value;
            console.log(userId, "done")
            fetch('http://localhost:4000/updateById/' + userId, {
                method: 'PUT',
                body: JSON.stringify({
                    name: document.getElementById("name").value,
                    email: document.getElementById("email").value,
                    messages: document.getElementById("message").value,
                }),
                headers: {
                    'Content-type': 'application/json; charset=UTF-8',
                },
            })
                .then((response) => response.text())
                .then((json) => {
                    console.log(json)
                    resetForm();
                    getData();
                });
            if (btn) {
                document.getElementById("btn").value = "Update Data";
                document.getElementById("btn").onclick = updateData;
            }
            else {
                document.getElementById("btn").value = "Create user";
                document.getElementById("btn").onclick = createUser;

            }
        }

        function resetForm() {
            console.log("Resett")
            document.getElementById("myForm").reset();
            document.getElementById("resetBtn").disabled = true;
            document.getElementById("btn").disabled = true;

        };

        function deleteData(id) {
            fetch('http://localhost:4000/deleteById/' + id, {
                method: 'PUT',
                headers: {
                    'Content-type': 'application/json; charset=UTF-8',
                },
            })
                .then((response) => response.text())
                .then((json) => {
                    console.log(json)
                    getData();
                });
        }

    </script>
</body>

</html>